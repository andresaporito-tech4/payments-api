name: Deploy Payments API

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build and Deploy Payments API
    runs-on: self-hosted

    steps:
      # ---------------------------------------------------
      # 1Ô∏è‚É£ Checkout do c√≥digo
      # ---------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 2Ô∏è‚É£ Configurar kubeconfig (Docker Desktop)
      # ---------------------------------------------------
      - name: Configure kubeconfig
        shell: powershell
        run: |
          $source = "C:\Users\Matheus\.kube\config"
          $targetDir = "C:\actions-runner-payments\_kube"
          $target = "$targetDir\config"

          if (-not (Test-Path $source)) {
            Write-Error "‚ùå kubeconfig n√£o encontrado em $source"
            exit 1
          }

          New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
          Copy-Item $source $target -Force

          "KUBECONFIG=$target" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "‚úÖ KUBECONFIG configurado em $target"

      # ---------------------------------------------------
      # 3Ô∏è‚É£ Validar Docker e Kubernetes
      # ---------------------------------------------------
      - name: Validate Docker and Kubernetes
        shell: powershell
        run: |
          docker info
          kubectl version --client
          kubectl cluster-info

      # ---------------------------------------------------
      # 4Ô∏è‚É£ Build da imagem Docker (LOCAL)
      #    Contexto = Payments.Api
      # ---------------------------------------------------
      - name: Build Docker image
        shell: powershell
        run: |
          docker build `
            -t payments-api:latest `
            -f Payments.Api/dockerfile `
            Payments.Api

      # ---------------------------------------------------
      # 5Ô∏è‚É£ Deploy no Kubernetes
      #    üëâ Garantir diret√≥rio raiz
      # ---------------------------------------------------
      - name: Deploy to Kubernetes
        shell: powershell
        run: |
          Write-Host "Diret√≥rio atual:"
          Get-Location

          Write-Host "Conte√∫do do workspace:"
          Get-ChildItem

          kubectl apply -f .\k8s -n fiap-cloud-games

      # ---------------------------------------------------
      # 6Ô∏è‚É£ Verifica√ß√£o final
      # ---------------------------------------------------
      - name: Verify deployment
        shell: powershell
        run: |
          kubectl get pods -n fiap-cloud-games
          kubectl get svc  -n fiap-cloud-games
